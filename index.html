<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Repositorio Excel – Accesos</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; margin: 30px; background: #f4f4f4 }
    h1, h2 { margin-top: 0 }
    input, select, button { padding: 8px; margin: 4px 0 }
    table { border-collapse: collapse; width: 100%; background: #fff }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: .9em }
    th { background: #eee }
    .filter-row td select { width: 100% }
    .hidden { display: none }
    #statusMsg { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<h1>Repositorio Excel – Accesos</h1>

<section id="loginSection">
  <h2>Acceso</h2>
  <label>Tipo de usuario:</label>
  <select id="userType">
    <option value="admin">Administrador</option>
    <option value="tv">Televendedor</option>
  </select><br>
  <label>Código o contraseña:</label>
  <input type="password" id="userCode">
  <button onclick="login()">Ingresar</button>
</section>

<section id="adminSection" class="hidden">
  <h2>Subir base Excel</h2>
  <input type="file" id="fileInput" accept=".xlsx"><br>
  <p><strong>Fecha actual:</strong> <span id="fechaHoy"></span></p>
  <button onclick="uploadBase()">Cargar</button>
  <button onclick="logout()">Cerrar sesión</button>
  <p id="statusMsg"></p>
</section>

<section id="tvSection" class="hidden">
  <h2>Vista para Televendedor</h2>
  <p><strong>Código TV:</strong> <span id="tvCodeShow"></span></p>
  <button onclick="logout()">Cerrar sesión</button>
</section>

<section id="tableSection" class="hidden">
  <h2 id="tableTitle">Vista previa</h2>
  <table id="dataTable"><thead></thead><tbody></tbody></table>
</section>

<script>
const firebaseConfig = {/* Tu config aquí */};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const COLS = ['C','D','J','K','L','M','N','Q','S','T','V','W','AG','AH','AI'];
let colNames = [], currentData = [], rawExcelData = null;

function login() {
  const type = document.getElementById('userType').value;
  const code = document.getElementById('userCode').value.trim();
  if (type === 'admin' && code === '123456') {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('adminSection').classList.remove('hidden');
    document.getElementById('fechaHoy').textContent = new Date().toISOString().slice(0, 10);
  } else if (type === 'tv' && code === 'TV1010') {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('tvSection').classList.remove('hidden');
    document.getElementById('tvCodeShow').textContent = code;
    loadDataForTV(code);
  } else {
    alert('Credenciales incorrectas');
  }
}

function logout() { location.reload(); }

document.getElementById('fileInput').addEventListener('change', function(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type:'binary'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {header:1});
    const headers = json[0];
    colNames = COLS.map(c => headers[excelColToIndex(c)] || c);
    currentData = json.slice(1).map(row => {
      const obj = {};
      COLS.forEach((c,i) => obj[colNames[i]] = row[excelColToIndex(c)]);
      return obj;
    });
    rawExcelData = { headers: colNames, rows: currentData };
    document.getElementById('statusMsg').textContent = '✅ Archivo cargado. Presiona "Cargar".';
    showTable(currentData);
  };
  reader.readAsBinaryString(file);
});

function uploadBase() {
  if (!rawExcelData) return alert("Primero selecciona un archivo.");
  const fecha = new Date().toISOString().slice(0,10);
  document.getElementById('statusMsg').textContent = '⏳ Cargando base en Firebase...';
  db.ref('bases/' + fecha).set(rawExcelData)
    .then(() => {
      document.getElementById('statusMsg').textContent = '✅ Base cargada correctamente para ' + fecha;
    })
    .catch(err => {
      document.getElementById('statusMsg').textContent = '❌ Error al cargar: ' + err.message;
      console.error('Error firebase write:', err);
    });
}

function loadDataForTV(tvCode) {
  const today = new Date().toISOString().slice(0,10);
  db.ref('bases/' + today).once('value', snap => {
    if (!snap.exists()) return alert('No hay base para hoy.');
    const { headers, rows } = snap.val();
    colNames = headers;
    currentData = rows.filter(row => row[colNames[10]] === tvCode);
    showTable(currentData, true);
  });
}

function showTable(data, useDropdownFilters = false) {
  const tbl = document.getElementById('dataTable');
  tbl.innerHTML = '';
  const head = tbl.createTHead();
  const hRow = head.insertRow();
  colNames.forEach(name => { const th = document.createElement('th'); th.textContent = name; hRow.appendChild(th); });
  const fRow = head.insertRow(); fRow.className = 'filter-row';
  colNames.forEach((name, i) => {
    const td = document.createElement('td');
    if (useDropdownFilters) {
      const select = document.createElement('select');
      const values = [...new Set(data.map(r => r[name]).filter(Boolean))];
      select.innerHTML = `<option value="">(Todos)</option>` + values.map(v => `<option>${v}</option>`).join('');
      select.onchange = applySelectFilters;
      td.appendChild(select);
    }
    fRow.appendChild(td);
  });
  const tbody = tbl.createTBody(); tbody.id = 'tbody';
  renderRows(data);
  document.getElementById('tableSection').classList.remove('hidden');
}

function renderRows(data) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  data.forEach(row => {
    const tr = tbody.insertRow();
    colNames.forEach(name => {
      const td = tr.insertCell();
      td.textContent = row[name] ?? '';
    });
  });
}

function applySelectFilters() {
  const filters = [...document.querySelectorAll('.filter-row select')].map(s => s.value);
  const filtered = currentData.filter(row => filters.every((f,i) => !f || row[colNames[i]] === f));
  renderRows(filtered);
}

function excelColToIndex(col) {
  let idx = 0;
  for (let c of col) idx = idx * 26 + (c.charCodeAt(0) - 64);
  return idx - 1;
}
</script>
</body>
</html>

