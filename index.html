// index.js  (todo-in-one: Realtime Database + Excel)
const express = require('express');
const admin   = require('firebase-admin');
const XLSX    = require('xlsx');

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 1) Service-account key embebida
const serviceAccount = {
  type: "service_account",
  project_id: "rutero-f91fb",
  private_key_id: "676046c978ba797582da33eded740deb619e2501",
  private_key: `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDlOewF/fVheZG6
9A+2ZOYwyKQ6YF7Mm7gqBGkgVkDeqhLL7S4zlwmGV7adAtvb3sn832HRioDbW2yL
3tcqxhg8zpvT8ARXECJ0DGx9z6SBFbJuM4MB/F+EkP8chbAoLwoyqdc2oEZJdH0W
fIfo/T0Y7IleK7u2BovYM1jLj2XUEPEfKx8OlcNdNu5JI7NxkCw6/lmOAfKTddue
H+hNxwoO9TCxTVQ7p/DXJuMVmOeQsY1gwADCD9Kh8dvaehQYuWIWPrqtoy0RVL23
ChatW2VqnFvpPF2zmDSwU8EdL/7M/kn8uhqqPySlN95ppYEqADifFjPCep1/aPXD
K2Ijum5FAgMBAAECggEABUjzlyPGz4uE/6F250amRAOsPahRJziD43wcjGFQt5GG
Q2thgFEAKDfHfxE8znHxiEICOFmQJP6TnxnxLgxJLMW6tAU5pGQ71x8eNTxfV5aP
eZj4cUhHT4AkUZ0HdbW373kY/Cpv1Gu6IpWWcJm+GeACPsiVWFoISWDNsEvLFjuO
li519S4hJRDYbeXjqqHsKCdgPxiyNzt5wR+WUFe4OPnRRmOZ4nYyQkIE9tlJlm9E
C3NDyrp6hoOTeRuygzZ3hAbEs98CEJ+EFoYOCs4LEB/GCbF7Cos3SW5wxUfUNJph
XlndZ9o1e3boA3EOOJMMsAZRadh/9WBN3K3Pe/X4gQKBgQD7FLr1pFAH8y7NS1Jw
nxHJLtxtM7RTfEZXr7XWRayiPrXRU08ozZdOU3YJMul25eBEFYhC9LkonSA+9UCz
2vZKvAOdsw2V21Yp5Y5xxgrsotO/0G7l8KwE/Zdsjuz3Oqbb2mQcIuwuztkxYfDy
UvZVuRmOG/fZUrLxByeQX6Mj4QKBgQDpt5TnOyhd2+Lw6yB0tscbB3fA5m1AOaGK
RJfpCvpJ4IFnzaoWv+IXK7Zni+XAV/5w/LjNOInJiHG4kKcOw3D3aslOV6WyYZuD
YJ9L+sidr8DJ7oczphOw2/Oyoib+Ar1tq95sBknBM6ggApxjMPUAtFg7OWqSYosd
ImcTCHYW5QKBgQDP4JX6EpSAQIMbTaVvwQOEwduWPhyqklXa+4tdYEpR+gGm0YbU
jYMcQlWTwCczXZeURw+N//fc/FpaRcvQHRWVQpzrz/cLf5GTFpAc+o7I5PbT9Moc
bmq9pwfbxWnENzc3B1WjRfatumxwSlqnBrEUwC+8TMOjlqi4jeffzI7RgQKBgGPF
a/p+JZBT0wB3z2YjtMGUIYomlBLrx0soVxU0C37IKVXv1SFbDqBHl9mCPjUrG0KO
kDGDZkazSaC5l6dUxX/JhWA9SE3rHyEpeTdNOqEeKxXJDsx8pEFG1DS4xh5/evA7
g3roAEpKzAXGN46ckqqXUmcN7rHJAYwRaKEWZpsFAoGASLmh5ziMb1AQkgddsYVF
2kG0om3ws9jIinNqkiiM1atFsWKgQh1eWP7ghH83UkS10MaHPZD7k+75qKhZxL4z
KaAunqolX0HubPboztYQe/JXJivspkGrcNvURJ8qlSKl9c2uqcmMKlSmoJ1XIzC/
Gj8A0uCQLhdo9D3wD89VKa4=
-----END PRIVATE KEY-----`,
  client_email: "firebase-adminsdk-fbsvc@rutero-f91fb.iam.gserviceaccount.com",
  client_id: "110915338152933328332",
  auth_uri: "https://accounts.google.com/o/oauth2/auth",
  token_uri: "https://oauth2.googleapis.com/token",
  auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
  client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40rutero-f91fb.iam.gserviceaccount.com",
  universe_domain: "googleapis.com"
};

// 2) Inicializar Firebase Realtime Database
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: 'https://rutero-f91fb-default-rtdb.firebaseio.com'
});
const db = admin.database();
const PASSWORD = 'reporte123';

// 3) Página HTML
app.get('/', (_, res) => res.send(`
<!doctype html>
<title>Rutero – Ingreso / Reporte</title>
<meta charset="utf-8">
<style>
  body{font-family:Arial;margin:30px;background:#f7f7f7}
  .radio-group{display:flex;gap:10px;margin:8px 0}
  .radio-group input[type=radio]{display:none}
  .radio-group label{padding:8px 16px;border:1px solid #000;cursor:pointer;border-radius:4px;font-weight:bold}
  .radio-group input[type=radio]:checked+label{background:#000;color:#fff}
  .hidden{display:none}
</style>

<h2>Ingresar datos</h2>
<form id="ingreso">
  <label>Código:</label><br><input name="codigo" required><br><br>

  <label>Opción:</label><br>
  <select name="opcion" required>
    <option disabled selected>Seleccionar…</option>
    <option>NO VISITA DE EJECUTIVO</option>
    <option>NO HAY DEVOLUCIONES</option>
    <option>NO HAY CAMBIOS DE PRODUCTOS</option>
    <option>CUPO LIMITADO</option>
    <option>CLIENTE BLOQUEADO</option>
    <option>SIN CREDITO</option>
    <option>PROBLEMA EN FRECUENCIA DE LLAMADA</option>
    <option>PROBLEMAS CON DESCUENTOS</option>
    <option>BAJA ROTACION</option>
    <option>NEGOCIO CERRADO</option>
    <option>COMPRA A LA COMPETENCIA</option>
    <option>PROBLEMAS CON LOGISTICA</option>
    <option>PROBLEMAS DE INSUFICIENCIA</option>
    <option>EJECUTIVO NO ENCUENTRA AL CLIENTE</option>
    <option>TIENE OTRO CODIGO</option>
    <option>PEDIDOS SIN CONSENTIMIENTO</option>
    <option>POR VACACIONES</option>
    <option>FALTA DE AGUA</option>
    <option>CLIENTE CERRADO TOTALMENTE</option>
    <option>DELINCUENCIA (EXTORSION, VACUNAS, SECUESTROS)</option>
    <option>COMPARTE CODIGO</option>
    <option>COMPRA CADA 15 DIAS (O 1 VEZ AL MES)</option>
    <option>CIERRE TEMPORAL (TEMA PERSONAL DEL CLIENTE)</option>
    <option>NO CONTACTO (TELEFONO INCORRECTO)</option>
  </select><br><br>

  <label>¿Contestó?</label>
  <div class="radio-group">
    <input type="radio" id="si" name="contesto" value="Sí" required><label for="si">Sí</label>
    <input type="radio" id="no" name="contesto" value="No"><label for="no">No</label>
  </div><br>

  <label>Detalle:</label><br><textarea name="detalle" rows="4" cols="40"></textarea><br><br>
  <button type="submit">Ingresar</button>
  <span id="msg1"></span>
</form>

<hr>

<h2>Zona de reportes</h2>
<label>Contraseña:</label><br><input type="password" id="pass"><br><br>
<button id="btnPass">Entrar</button>

<div id="reporte" class="hidden">
  <label>Fecha para reporte:</label><br><input type="date" id="fecha"><br><br>
  <button id="btnDesc">Descargar Excel</button>
</div>

<script>
  // Guardar
  document.getElementById('ingreso').addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    data.fecha = new Date().toISOString().slice(0,10);
    await fetch('/ingresar', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
    document.getElementById('msg1').textContent = '✅ Guardado';
    e.target.reset();
  });

  // Mostrar zona
  document.getElementById('btnPass').onclick = () => {
    if(document.getElementById('pass').value === '${PASSWORD}'){
      document.getElementById('reporte').classList.remove('hidden');
    }else alert('Contraseña incorrecta');
  };

  // Descargar Excel
  document.getElementById('btnDesc').onclick = () => {
    const fecha = document.getElementById('fecha').value;
    if(!fecha) return alert('Elegí fecha');
    window.location.href = '/reporte?fecha=' + fecha;
  };
</script>
`));

// 4) Guardar en Realtime Database
app.post('/ingresar', async (req, res) => {
  try {
    await db.ref('registros').push(req.body);
    res.sendStatus(200);
  } catch (e) {
    res.status(500).send('❌ Error al guardar');
  }
});

// 5) Descargar Excel
app.get('/reporte', async (req, res) => {
  const fecha = req.query.fecha;
  const snap  = await db.ref('registros')
                        .orderByChild('fecha')
                        .equalTo(fecha)
                        .once('value');
  const rows = [];
  snap.forEach(child => rows.push(child.val()));

  if (!rows.length) return res.status(404).send('Sin datos para la fecha seleccionada');

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Reporte');

  const buf = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' });

  res.setHeader('Content-Disposition', `attachment; filename="reporte_${fecha}.xlsx"`);
  res.type('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.send(buf);
});

// 6) Arrancar
app.listen(3000, () => console.log('Servidor corriendo en http://localhost:3000'));
