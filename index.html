<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rutero – Ingreso / Reporte</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family: Arial; margin: 30px; background: #f7f7f7 }
.radio-group { display: flex; gap: 10px; margin: 8px 0 }
.radio-group input[type=radio] { display: none }
.radio-group label {
  padding: 8px 16px; border: 1px solid #000; cursor: pointer;
  border-radius: 4px; font-weight: bold;
}
.radio-group input[type=radio]:checked + label {
  background: #000; color: #fff;
}
.hidden { display: none }
#msg1 { margin-left: 10px; font-weight: bold; color: green; }
</style>
</head>

<body>
<h2>Ingresar datos</h2>
<form id="ingreso">
  <label>Código:</label><br><input name="codigo" required><br><br>

  <label>Opción:</label><br>
  <select name="opcion" required>
    <option disabled selected>Seleccionar…</option>
    <option>NO VISITA DE EJECUTIVO</option>
    <option>NO HAY DEVOLUCIONES</option>
    <option>NO HAY CAMBIOS DE PRODUCTOS</option>
    <option>CUPO LIMITADO</option>
    <option>CLIENTE BLOQUEADO</option>
    <option>SIN CREDITO</option>
    <option>PROBLEMA EN FRECUENCIA DE LLAMADA</option>
    <option>PROBLEMAS CON DESCUENTOS</option>
    <option>BAJA ROTACION</option>
    <option>NEGOCIO CERRADO</option>
    <option>COMPRA A LA COMPETENCIA</option>
    <option>PROBLEMAS CON LOGISTICA</option>
    <option>PROBLEMAS DE INSUFICIENCIA</option>
    <option>EJECUTIVO NO ENCUENTRA AL CLIENTE</option>
    <option>TIENE OTRO CODIGO</option>
    <option>PEDIDOS SIN CONSENTIMIENTO</option>
    <option>POR VACACIONES</option>
    <option>FALTA DE AGUA</option>
    <option>CLIENTE CERRADO TOTALMENTE</option>
    <option>DELINCUENCIA (EXTORSION, VACUNAS, SECUESTROS)</option>
    <option>COMPARTE CODIGO</option>
    <option>COMPRA CADA 15 DIAS (O 1 VEZ AL MES)</option>
    <option>CIERRE TEMPORAL (TEMA PERSONAL DEL CLIENTE)</option>
    <option>NO CONTACTO (TELEFONO INCORRECTO)</option>
  </select><br><br>

  <label>¿Contestó?</label>
  <div class="radio-group">
    <input type="radio" id="si" name="contesto" value="Sí" required><label for="si">Sí</label>
    <input type="radio" id="no" name="contesto" value="No"><label for="no">No</label>
  </div><br>

  <label>Detalle:</label><br><textarea name="detalle" rows="4" cols="40"></textarea><br><br>
  <button type="submit">Ingresar</button>
  <span id="msg1"></span>
</form>

<hr>

<h2>Zona de reportes</h2>
<label>Contraseña:</label><br><input type="password" id="pass"><br><br>
<button id="btnPass">Entrar</button>

<div id="reporte" class="hidden">
  <label>Fecha para reporte:</label><br><input type="date" id="fecha"><br><br>
  <button id="btnDesc">Descargar Excel</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD7o4v2t7Y4v2t7Y4v2t7Y4v2t7Y4v2t7Y4v2t7",
    authDomain: "rutero-f91fb.firebaseapp.com",
    databaseURL: "https://rutero-f91fb-default-rtdb.firebaseio.com",
    projectId: "rutero-f91fb",
    storageBucket: "rutero-f91fb.appspot.com",
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef123456"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const PASSWORD = 'reporte123';

  // Guardar formulario
  document.getElementById('ingreso').addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    data.fecha = new Date().toISOString().split('T')[0]; // Solo YYYY-MM-DD
    
    try {
      await db.ref('registros').push(data);
      document.getElementById('msg1').textContent = '✅ Guardado';

      setTimeout(() => {
        document.getElementById('msg1').textContent = '';
      }, 3000);

      e.target.reset();
    } catch (err) {
      console.error("Error al guardar:", err);
      document.getElementById('msg1').textContent = '❌ Error al guardar';
    }
  });

  // Borrar mensaje si cambia el código
  document.querySelector('input[name="codigo"]').addEventListener('input', () => {
    document.getElementById('msg1').textContent = '';
  });

  // Mostrar zona de reportes
  document.getElementById('btnPass').onclick = () => {
    if(document.getElementById('pass').value === PASSWORD){
      document.getElementById('reporte').classList.remove('hidden');
    } else {
      alert('Contraseña incorrecta');
    }
  };

  // Descargar Excel
  document.getElementById('btnDesc').onclick = async () => {
    const fecha = document.getElementById('fecha').value;
    if (!fecha) return alert('Elegí fecha');

    const snap = await db.ref('registros').once('value');
    const rows = [];
    snap.forEach(child => {
      const val = child.val();
      if (val.fecha && val.fecha.startsWith(fecha)) {
        rows.push(val);
      }
    });

    if (!rows.length) return alert('Sin datos para la fecha seleccionada');

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
    XLSX.writeFile(wb, `reporte_${fecha}.xlsx`);
  };
</script>
</body>
</html>
