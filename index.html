// ==========================
// index.js  (Replit – guardar en Firestore y descargar Excel)
// ==========================
const express = require('express');
const admin   = require('firebase-admin');
const XLSX    = require('xlsx');          // <-- para Excel
const fs      = require('fs');

const app = express();
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// ---------- Conexión a Firebase ----------
// Opción A: archivo físico
admin.initializeApp({
  credential: admin.credential.cert(require('./firebase-key.json'))
});
// Opción B: con Secrets (descomentar si usás Secrets)
// const serviceAccount = JSON.parse(process.env.FIREBASE_KEY);
// admin.initializeApp({ credential: admin.credential.cert(serviceAccount) });

const db = admin.firestore();

// ---------- Config ----------
const PASSWORD = 'reporte123';   // contraseña para descargar reportes

// ---------- Rutas ----------
// Página principal
app.get('/', (_, res) => {
  res.send(`
<!doctype html>
<title>Rutero – Ingreso / Reporte</title>
<meta charset="utf-8">
<style>
  body{font-family:Arial;margin:30px;background:#f7f7f7}
  form,hr{margin-bottom:30px}
  .radio-group{display:flex;gap:10px;margin:8px 0}
  .radio-group input[type=radio]{display:none}
  .radio-group label{
    padding:8px 16px;border:1px solid #000;cursor:pointer;border-radius:4px;font-weight:bold
  }
  .radio-group input[type=radio]:checked + label{background:#000;color:#fff}
  .hidden{display:none}
</style>

<h2>Ingresar datos</h2>
<form id="ingreso">
  <label>Código:</label><br>
  <input name="codigo" required><br><br>

  <label>Opción:</label><br>
  <select name="opcion" required>
    <option value="" disabled selected>Seleccionar…</option>
    <option>NO VISITA DE EJECUTIVO</option>
    <option>NO HAY DEVOLUCIONES</option>
    <option>NO HAY CAMBIOS DE PRODUCTOS</option>
    <option>CUPO LIMITADO</option>
    <option>CLIENTE BLOQUEADO</option>
    <option>SIN CREDITO</option>
    <option>PROBLEMA EN FRECUENCIA DE LLAMADA</option>
    <option>PROBLEMAS CON DESCUENTOS</option>
    <option>BAJA ROTACION</option>
    <option>NEGOCIO CERRADO</option>
    <option>COMPRA A LA COMPETENCIA</option>
    <option>PROBLEMAS CON LOGISTICA</option>
    <option>PROBLEMAS DE INSUFICIENCIA</option>
    <option>EJECUTIVO NO ENCUENTRA AL CLIENTE</option>
    <option>TIENE OTRO CODIGO</option>
    <option>PEDIDOS SIN CONSENTIMIENTO</option>
    <option>POR VACACIONES</option>
    <option>FALTA DE AGUA</option>
    <option>CLIENTE CERRADO TOTALMENTE</option>
    <option>DELINCUENCIA (EXTORSION, VACUNAS, SECUESTROS)</option>
    <option>COMPARTE CODIGO</option>
    <option>COMPRA CADA 15 DIAS (O 1 VEZ AL MES)</option>
    <option>CIERRE TEMPORAL (TEMA PERSONAL DEL CLIENTE)</option>
    <option>NO CONTACTO (TELEFONO INCORRECTO)</option>
  </select><br><br>

  <label>¿Contestó?</label>
  <div class="radio-group">
    <input type="radio" id="si" name="contesto" value="Sí" required>
    <label for="si">Sí</label>
    <input type="radio" id="no" name="contesto" value="No">
    <label for="no">No</label>
  </div><br>

  <label>Detalle:</label><br>
  <textarea name="detalle" rows="4" cols="40"></textarea><br><br>

  <button type="submit">Ingresar</button>
  <span id="msg1"></span>
</form>

<hr>

<h2>Zona de reportes</h2>
<label>Contraseña:</label><br>
<input type="password" id="pass"><br><br>
<button id="btnPass">Entrar</button>

<div id="reporte" class="hidden">
  <label>Fecha para reporte:</label><br>
  <input type="date" id="fecha"><br><br>
  <button id="btnDesc">Descargar Excel</button>
</div>

<script>
  // Ingresar datos
  document.getElementById('ingreso').addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    data.fecha = new Date().toISOString().slice(0,10); // solo fecha
    await fetch('/ingresar', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    document.getElementById('msg1').textContent = '✅ Guardado';
    e.target.reset();
  });

  // Mostrar selector de fecha
  document.getElementById('btnPass').onclick = () => {
    if(document.getElementById('pass').value === '${PASSWORD}'){
      document.getElementById('reporte').classList.remove('hidden');
    }else{
      alert('Contraseña incorrecta');
    }
  };

  // Descargar Excel
  document.getElementById('btnDesc').onclick = () => {
    const fecha = document.getElementById('fecha').value;
    if(!fecha) return alert('Elegí fecha');
    window.location.href = '/reporte?fecha='+fecha;
  };
</script>
  `);
});

// Guardar en Firestore
app.post('/ingresar', async (req, res) => {
  try {
    await db.collection('registros').add(req.body);
    res.sendStatus(200);
  } catch (e) {
    res.status(500).send('❌ Error al guardar');
  }
});

// Descargar reporte en Excel (.xlsx)
app.get('/reporte', async (req, res) => {
  const fecha = req.query.fecha;
  const snap = await db.collection('registros').where('fecha', '==', fecha).get();
  const rows = snap.docs.map(d => d.data());

  if (!rows.length) {
    return res.status(404).send('Sin datos para la fecha seleccionada');
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Reporte');

  const buf = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' });

  res.setHeader('Content-Disposition', `attachment; filename="reporte_${fecha}.xlsx"`);
  res.type('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.send(buf);
});

// ---------- Iniciar servidor ----------
app.listen(3000, () => console.log('Servidor corriendo en http://localhost:3000'));
